<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Verbale di Sopralluogo v2.0</title>
<style>
*{box-sizing:border-box}
body{margin:0;font-family:'Inter',-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#f0f4f8;color:#1a202c;min-height:100vh;padding-bottom:60px}

/* Header moderno con gradiente */
header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,0.95);backdrop-filter:blur(20px);border-bottom:1px solid rgba(0,0,0,0.08);box-shadow:0 4px 20px rgba(0,0,0,0.08)}
.header-content{max-width:1200px;margin:0 auto;display:flex;gap:16px;align-items:center;justify-content:space-between;padding:16px 24px;flex-wrap:wrap}
header h1{font-size:24px;font-weight:700;margin:0;background:linear-gradient(135deg, #17a2b8 0%, #8bc34a 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.header-subtitle{font-size:13px;color:#4a5568;margin-top:2px}

/* Buttons moderni */
.actions{display:flex;gap:10px;flex-wrap:wrap}
button{border:none;background:linear-gradient(135deg, #17a2b8 0%, #8bc34a 100%);color:#fff;padding:10px 18px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 2px 8px rgba(23,162,184,0.3)}
button:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(23,162,184,0.4)}
button.secondary{background:#fff;color:#17a2b8;border:2px solid #17a2b8;box-shadow:none}
button.secondary:hover{background:#f7fafc;box-shadow:0 2px 8px rgba(23,162,184,0.2)}
button.ghost{background:transparent;color:#4a5568;border:1px solid #e2e8f0;box-shadow:none}
button.ghost:hover{background:#f7fafc}
label.file{border:2px dashed #cbd5e0;border-radius:10px;padding:9px 16px;background:#fff;color:#4a5568;cursor:pointer;font-weight:600;transition:all 0.3s ease}
label.file:hover{border-color:#17a2b8;color:#17a2b8;background:#f7fafc}
label.file input{display:none}

/* Container principale */
.container{max-width:1200px;margin:24px auto;padding:0 24px}

/* Cards moderne con ombre */
.card{background:#fff;border-radius:20px;padding:24px;margin-bottom:20px;box-shadow:0 8px 30px rgba(0,0,0,0.12);transition:all 0.3s ease}
.card:hover{box-shadow:0 12px 40px rgba(0,0,0,0.15);transform:translateY(-2px)}

/* Sezioni con header migliorati */
.section{margin-top:20px}
.section h3{background:linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);border:1px solid #e2e8f0;border-radius:12px;padding:12px 16px;margin:0 0 16px;font-size:16px;font-weight:700;color:#2d3748;display:flex;align-items:center;gap:10px}
.section h3::before{content:'';width:4px;height:20px;background:linear-gradient(135deg, #17a2b8 0%, #8bc34a 100%);border-radius:2px}

/* Badge per documento */
.doc-badge{display:inline-block;background:linear-gradient(135deg, #17a2b8 0%, #8bc34a 100%);color:#fff;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;margin-left:8px}

/* Grid migliorato */
.grid{display:grid;gap:16px}
.g2{grid-template-columns:repeat(2,minmax(0,1fr))}
.g3{grid-template-columns:repeat(3,minmax(0,1fr))}
.g4{grid-template-columns:repeat(4,minmax(0,1fr))}

/* Form elements moderni */
label{font-size:13px;font-weight:600;display:flex;flex-direction:column;gap:8px;color:#4a5568}
input,select,textarea{border:2px solid #e2e8f0;border-radius:10px;padding:12px 14px;font-size:14px;background:#fff;transition:all 0.3s ease;font-family:inherit}
input:focus,select:focus,textarea:focus{outline:none;border-color:#17a2b8;box-shadow:0 0 0 3px rgba(23,162,184,0.1)}
input::placeholder{color:#a0aec0}

/* Coordinate specifiche con icona */
.coordinate-group{position:relative}
.coordinate-group::before{content:'üìç';position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:16px;pointer-events:none}
.coordinate-group input{padding-left:38px}

/* Meteo card speciale */
.meteo-card{background:linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);border:2px solid #7dd3fc;padding:20px;border-radius:16px;margin-bottom:16px}
.meteo-header{font-size:15px;font-weight:700;color:#0c4a6e;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.meteo-header::before{content:'üå§Ô∏è';font-size:20px}

/* Inline elements */
.inline{display:inline-flex;align-items:center;gap:8px;margin-right:12px;cursor:pointer;user-select:none}
.inline input[type="radio"],.inline input[type="checkbox"]{width:18px;height:18px;cursor:pointer}
.inline-row{display:flex;align-items:center;gap:12px;margin-top:8px;flex-wrap:wrap}
.field{margin:8px 0}
.label{font-size:13px;font-weight:600;margin-bottom:8px;color:#4a5568}

/* Chips moderni */
.chips{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
.chips label{flex-direction:row;gap:10px;align-items:center;background:#f7fafc;padding:10px 14px;border-radius:10px;border:2px solid #e2e8f0;transition:all 0.3s ease;cursor:pointer}
.chips label:hover{background:#edf2f7;border-color:#cbd5e0}
.chips input:checked + label,.chips label:has(input:checked){background:linear-gradient(135deg, rgba(23,162,184,0.1) 0%, rgba(139,195,74,0.1) 100%);border-color:#17a2b8;color:#17a2b8}

/* Allegati grid */
.allegati-grid{display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:10px}
.allegati-grid label{flex-direction:row;gap:10px;align-items:center;font-size:14px;background:#f7fafc;padding:10px 14px;border-radius:10px;border:2px solid #e2e8f0;cursor:pointer;transition:all 0.3s ease}
.allegati-grid label:hover{background:#edf2f7}
.allegati-grid label:has(input:checked){background:linear-gradient(135deg, rgba(23,162,184,0.1) 0%, rgba(139,195,74,0.1) 100%);border-color:#17a2b8}
.allegati-extra{display:flex;align-items:center;gap:12px;margin-top:12px}

/* Tables moderne */
.table{border:2px solid #e2e8f0;border-radius:12px;overflow:hidden;background:#fff}
.table .row{display:grid;gap:8px;padding:12px;border-top:1px solid #f1f5f9;transition:background 0.2s ease}
.table .row:hover:not(.head){background:#f8fafc}
.table .head{background:linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);font-weight:700;color:#2d3748;border-top:none}
.table .row input,.table .row select,.table .row textarea{width:100%;border:1px solid #e2e8f0}
.table .row textarea{height:60px;resize:vertical}

/* Riepilogo cards */
.riepilogo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:16px}
.riepilogo-item{background:linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);padding:20px;border-radius:12px;text-align:center;border:2px solid #e2e8f0}
.riepilogo-value{font-size:32px;font-weight:700;background:linear-gradient(135deg, #17a2b8 0%, #8bc34a 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.riepilogo-label{font-size:12px;color:#4a5568;margin-top:4px;font-weight:600}

/* Status badge */
.status-badge{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:20px;font-size:13px;font-weight:700;margin-top:12px}
.status-badge.valid{background:#d1fae5;color:#065f46;border:2px solid #6ee7b7}
.status-badge.invalid{background:#fee2e2;color:#991b1b;border:2px solid #fca5a5}

/* Firma pads moderni */
.sigpad{border:2px solid #e2e8f0;border-radius:12px;background:#fafafa;height:180px;touch-action:none;cursor:crosshair;transition:border-color 0.3s ease}
.sigpad:hover{border-color:#cbd5e0}
.sigtools{display:flex;gap:10px;margin-top:10px}

/* Footer sticky */
.sticky{position:sticky;bottom:0;background:rgba(255,255,255,0.98);backdrop-filter:blur(20px);border-top:2px solid rgba(23,162,184,0.2);padding:16px 24px;display:flex;justify-content:center;box-shadow:0 -4px 20px rgba(0,0,0,0.08)}

.small{font-size:12px;color:#4a5568}

/* Responsive */
@media (max-width:768px){
  .header-content{flex-direction:column;align-items:stretch}
  .actions{width:100%}
  .g2,.g3,.g4{grid-template-columns:1fr}
  .chips{grid-template-columns:repeat(2,minmax(0,1fr))}
  .allegati-grid{grid-template-columns:1fr}
  .table .row{grid-template-columns:1fr!important;gap:6px}
  .riepilogo-grid{grid-template-columns:1fr}
}

@media print { 
  body{background:#fff;padding:0}
  header, .sticky { display:none !important } 
  .section h3{background:#eee;page-break-after:avoid}
  .card{box-shadow:none;page-break-inside:avoid}
}
</style>
</head>
<body>
<header>
  <div class="header-content">
    <div>
      <h1>üìã Verbale di Sopralluogo <span class="doc-badge">v2.0</span></h1>
      <div class="header-subtitle">Sistema di gestione verbali cantiere</div>
    </div>
    <div class="actions">
      <button id="btnExportPDF">üìÑ Esporta PDF</button>
      <button id="btnPrint" class="secondary">üñ®Ô∏è Stampa</button>
      <button id="btnExportJSON" class="ghost" title="Esporta dati senza immagini (ottimizzato per AI)">üíæ Salva JSON</button>
      <label class="file">üìÇ Importa <input type="file" id="fileImport" accept="application/json"></label>
      <button id="btnReset" class="ghost">üîÑ Nuovo</button>
    </div>
  </div>
</header>

<main id="print-root" class="container">
  <section class="card">
    <h2 style="margin:0 0 16px;font-size:18px;font-weight:700;color:#2d3748">Controllo Documento</h2>
    <div class="grid g3">
      <label>Data<input id="dataDoc" type="date"></label>
      <label>Autore<input id="autore" placeholder="Nome cognome"></label>
      <label>Codice Progetto<input id="progettoShort" placeholder="PRJ-001"></label>
    </div>
  </section>

  <section class="section">
    <h3>1Ô∏è‚É£ Intestazione Cantiere</h3>
    <div class="grid g2">
      <label>Progetto *<input id="progetto" placeholder="Nome completo progetto"></label>
      <label>Codice/Commessa<input id="codiceCommessa" placeholder="COM-2025-001"></label>
    </div>
    <div class="grid g3" style="margin-top:16px">
      <label>Comune *<input id="comune" placeholder="Nome comune"></label>
      <label>Indirizzo *<input id="indirizzo" placeholder="Via, numero civico"></label>
      <label>Provincia *<input id="provincia" maxlength="2" placeholder="VR" style="text-transform:uppercase"></label>
    </div>
    <div class="grid g2" style="margin-top:16px">
      <label>Committente<input id="committente" placeholder="Ragione sociale"></label>
      <label>Impresa<input id="impresa" placeholder="Impresa esecutrice"></label>
      <label>RUP<input id="rup" placeholder="Responsabile Unico Procedimento"></label>
    </div>
    <div class="grid g3" style="margin-top:16px">
      <label>Data Sopralluogo *<input id="dataVerbale" type="date"></label>
      <label>Ora Inizio *<input id="oraInizio" type="time"></label>
      <label>Ora Fine *<input id="oraFine" type="time"></label>
    </div>
    
    <div style="margin-top:20px">
      <label class="coordinate-group">Coordinate Cantiere (Lat, Long)
        <input id="coordinate" placeholder="es. 45.4384, 10.9916" pattern="^-?\d+\.?\d*,\s*-?\d+\.?\d*$">
      </label>
      <div class="small" style="margin-top:6px">üí° Formato: latitudine, longitudine (es. 45.4384, 10.9916)</div>
    </div>
  </section>

  <section class="section">
    <h3>üå§Ô∏è Condizioni Meteo e Ambientali</h3>
    <div class="meteo-card">
      <div class="meteo-header">Dati Meteorologici</div>
      <div class="grid g3">
        <label>Condizioni Generali
          <select id="meteo">
            <option value="">Seleziona...</option>
            <option>‚òÄÔ∏è Sereno</option>
            <option>‚õÖ Parzialmente nuvoloso</option>
            <option>‚òÅÔ∏è Nuvoloso</option>
            <option>üåßÔ∏è Pioggia leggera</option>
            <option>‚õàÔ∏è Pioggia forte</option>
            <option>‚ö° Temporale</option>
            <option>üí® Vento forte</option>
            <option>‚ùÑÔ∏è Neve</option>
            <option>üå´Ô∏è Nebbia</option>
          </select>
        </label>
        <label>Temperatura (¬∞C)
          <input id="temperatura" type="number" step="0.1" placeholder="es. 22.5">
        </label>
        <label>Visibilit√†
          <select id="visibilita">
            <option value="">Seleziona...</option>
            <option>Ottima (>10km)</option>
            <option>Buona (5-10km)</option>
            <option>Moderata (2-5km)</option>
            <option>Scarsa (<2km)</option>
          </select>
        </label>
      </div>
      <div style="margin-top:16px">
        <label>Note Meteo
          <textarea id="noteMeteo" rows="2" placeholder="Eventuali osservazioni sulle condizioni meteorologiche..."></textarea>
        </label>
      </div>
    </div>
    
    <div class="field">
      <div class="label">Stato Cantiere</div>
      <div class="inline-row">
        <label class="inline"><input type="radio" name="stato" value="aperto"> üü¢ Aperto</label>
        <label class="inline"><input type="radio" name="stato" value="chiuso"> üî¥ Chiuso</label>
        <label class="inline"><input type="radio" name="stato" value="sospeso"> ‚è∏Ô∏è Sospeso</label>
      </div>
    </div>
  </section>

  <section class="section">
    <h3>2Ô∏è‚É£ Partecipanti</h3>
    <div id="partecipanti"></div>
    <button id="addPartecipante" class="secondary" onclick="window.handleAddPartecipante && window.handleAddPartecipante()">+ Aggiungi Partecipante</button>
  </section>

  <section class="section">
    <h3>3Ô∏è‚É£ Aree Ispezionate</h3>
    <div class="field">
      <div class="label">Seleziona le aree oggetto di sopralluogo (multi-selezione)</div>
      <div class="chips" id="areeChips"></div>
    </div>
  </section>

  <section class="section">
    <h3>4Ô∏è‚É£ Lavorazioni in Corso</h3>
    <div class="field">
      <div class="label">Tipologie di lavorazione rilevate</div>
      <div class="chips" id="lavorazioniChips"></div>
    </div>
  </section>

  <section class="section">
    <h3>5Ô∏è‚É£ Osservazioni Generali</h3>
    <label>Descrizione Stato Lavori
      <textarea id="statoLavori" rows="4" placeholder="Descrivi lo stato di avanzamento generale dei lavori..."></textarea>
    </label>
    <label style="margin-top:12px">Aspetti Positivi Rilevati
      <textarea id="aspettiPositivi" rows="3" placeholder="Eventuali punti di forza o conformit√† rilevate..."></textarea>
    </label>
    <label style="margin-top:12px">Criticit√† e Problematiche
      <textarea id="criticita" rows="3" placeholder="Descrivi eventuali problematiche o aspetti da migliorare..."></textarea>
    </label>
  </section>

  <section class="section">
    <h3>5Ô∏è‚É£ Check-list Qualit√† & Sicurezza</h3>
    <div class="table" id="checklistTable"></div>
    <button id="addChecklist" class="secondary" style="margin-top:12px" onclick="window.handleAddChecklist && window.handleAddChecklist()">+ Aggiungi Voce</button>
  </section>

  <section class="section">
    <h3>6Ô∏è‚É£ Non Conformit√† e Prescrizioni</h3>
    <div class="table" id="ncTable"></div>
    <button id="addNC" class="secondary" style="margin-top:12px" onclick="window.handleAddNC && window.handleAddNC()">+ Aggiungi Non Conformit√†</button>
  </section>

  <section class="section">
    <h3>7Ô∏è‚É£ Azioni e Responsabilit√† (RACI)</h3>
    <div class="table" id="raciTable"></div>
    <button id="addRACI" class="secondary" style="margin-top:12px" onclick="window.handleAddRACI && window.handleAddRACI()">+ Aggiungi Azione</button>
  </section>

  <section class="section">
    <h3>8Ô∏è‚É£ Documentazione Fotografica</h3>
    <div class="table" id="fotoTable"></div>
    <button id="addFoto" class="secondary" style="margin-top:12px" onclick="window.handleAddFoto && window.handleAddFoto()">+ Aggiungi Foto</button>
  </section>

  <section class="section">
    <h3>9Ô∏è‚É£ Allegati</h3>
    <div class="field">
      <div class="label">Documenti allegati al verbale</div>
      <div class="allegati-grid" id="allegati"></div>
      <div class="allegati-extra">
        <label class="inline">
          <input type="checkbox" id="allegatiAltroChk">
          Altro (specificare):
        </label>
        <input type="text" id="allegatiAltro" placeholder="Specifica altri documenti..." style="flex:1">
      </div>
    </div>
  </section>

  <section class="section">
    <h3>üîü Riepilogo Finale</h3>
    <div class="riepilogo-grid">
      <div class="riepilogo-item">
        <div class="riepilogo-value" id="riepilogoNc">0</div>
        <div class="riepilogo-label">Non Conformit√†</div>
      </div>
      <div class="riepilogo-item">
        <div class="riepilogo-value" id="riepilogoPresc">0</div>
        <div class="riepilogo-label">Prescrizioni</div>
      </div>
      <div class="riepilogo-item">
        <div class="riepilogo-value" id="riepilogoScadenze">0</div>
        <div class="riepilogo-label">Scadenze Imminenti</div>
      </div>
    </div>
    <div style="margin-top:20px">
      <label>Note Conclusive
        <textarea id="noteFinali" rows="3" placeholder="Eventuali considerazioni finali o indicazioni per i prossimi sopralluoghi..."></textarea>
      </label>
    </div>
    <div style="margin-top:16px">
      <strong>Stato validit√†:</strong>
      <span class="status-badge" id="status">Dati incompleti</span>
    </div>
  </section>

  <section class="section">
    <h3>‚úçÔ∏è Firme</h3>
    <div class="grid g2">
      <div>
        <label>Firma Direttore Lavori</label>
        <canvas id="sigDL" class="sigpad"></canvas>
        <div class="sigtools">
          <button id="clearDL" class="secondary">üóëÔ∏è Cancella</button>
        </div>
      </div>
      <div>
        <label>Firma Impresa</label>
        <canvas id="sigIMP" class="sigpad"></canvas>
        <div class="sigtools">
          <button id="clearIMP" class="secondary">üóëÔ∏è Cancella</button>
        </div>
      </div>
    </div>
    
    <div style="margin-top:24px;padding-top:20px;border-top:2px dashed #e2e8f0">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <h4 style="margin:0;font-size:15px;color:#4a5568">Firme Aggiuntive</h4>
        <button id="addFirma" class="secondary" onclick="window.handleAddFirma && window.handleAddFirma()">+ Aggiungi Firma</button>
      </div>
      <div id="firmeAggiuntive"></div>
    </div>
  </section>
</main>

<div class="sticky">
  <button id="btnExportPDFBottom" style="padding:14px 28px;font-size:16px">üìÑ Esporta PDF Finale</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  console.log('üöÄ DOM Ready - Inizializzo webapp');
  
  const STORAGE = 'verbale_sopralluogo_v2';
  const $=id=>document.getElementById(id);
  const todayISO=()=>new Date().toISOString().split('T')[0];
  
  // CONFIGURAZIONE FOTO
  const FOTO_CONFIG = {
    MAX_WIDTH: 1200,           // Larghezza massima foto
    MAX_HEIGHT: 1200,          // Altezza massima foto
    QUALITY: 0.8,              // Qualit√† JPEG (0-1)
    MAX_FOTO_CHECKLIST: 20,    // Max foto in checklist
    MAX_FOTO_DOCUMENTAZIONE: 30, // Max foto in documentazione
    ESTIMATED_SIZE_KB: 80      // Dimensione stimata per foto compressa
  };
  
  // Funzione per comprimere immagine
  function compressImage(file, maxWidth, maxHeight, quality) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          // Calcola dimensioni mantenendo aspect ratio
          let width = img.width;
          let height = img.height;
          
          if (width > maxWidth || height > maxHeight) {
            const ratio = Math.min(maxWidth / width, maxHeight / height);
            width = width * ratio;
            height = height * ratio;
          }
          
          // Crea canvas per compressione
          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          
          // Converti a JPEG compresso
          const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
          
          // Calcola dimensione
          const sizeKB = Math.round((compressedDataUrl.length * 0.75) / 1024);
          console.log(`üì∏ Foto compressa: ${img.width}x${img.height} ‚Üí ${Math.round(width)}x${Math.round(height)} (${sizeKB} KB)`);
          
          resolve(compressedDataUrl);
        };
        img.onerror = reject;
        img.src = e.target.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }
  
  // Funzione per controllare limiti storage
  function checkStorageLimit() {
    try {
      const currentData = localStorage.getItem(STORAGE) || '{}';
      const currentSizeMB = (currentData.length * 2) / (1024 * 1024); // Stima approssimativa
      const limitMB = 5; // Limite conservativo
      
      if (currentSizeMB > limitMB * 0.9) { // Alert al 90%
        alert(`‚ö†Ô∏è ATTENZIONE: Stai usando ${currentSizeMB.toFixed(1)} MB di ${limitMB} MB disponibili!\n\nConsigli:\n- Esporta il PDF e inizia un nuovo verbale\n- Riduci il numero di foto`);
        return false;
      }
      return true;
    } catch(e) {
      console.error('Errore controllo storage:', e);
      return true;
    }
  }
  
  // ========== COMPRESSIONE IMMAGINI ==========
  const MAX_FOTO_CHECKLIST = 10;
  const MAX_FOTO_DOCUMENTAZIONE = 15;
  const MAX_WIDTH = 1200;  // Larghezza massima in pixel
  const MAX_HEIGHT = 1200; // Altezza massima in pixel
  const JPEG_QUALITY = 0.75; // Qualit√† JPEG (0-1)
  
  /**
   * Comprime un'immagine riducendo dimensioni e qualit√†
   * @param {File} file - File immagine da comprimere
   * @param {number} maxWidth - Larghezza massima
   * @param {number} maxHeight - Altezza massima
   * @param {number} quality - Qualit√† JPEG (0-1)
   * @returns {Promise<string>} - Immagine compressa in base64
   */
  function compressImage(file, maxWidth = MAX_WIDTH, maxHeight = MAX_HEIGHT, quality = JPEG_QUALITY) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      
      reader.onload = (e) => {
        const img = new Image();
        
        img.onload = () => {
          // Calcola nuove dimensioni mantenendo aspect ratio
          let width = img.width;
          let height = img.height;
          
          if (width > maxWidth || height > maxHeight) {
            const ratio = Math.min(maxWidth / width, maxHeight / height);
            width = Math.round(width * ratio);
            height = Math.round(height * ratio);
          }
          
          // Crea canvas per ridimensionare
          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;
          
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          
          // Converti in JPEG compresso
          const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
          
          // Calcola riduzione dimensione
          const originalSize = e.target.result.length;
          const compressedSize = compressedBase64.length;
          const reduction = ((1 - compressedSize / originalSize) * 100).toFixed(1);
          
          console.log(`üì∏ Immagine compressa: ${(originalSize/1024).toFixed(0)}KB ‚Üí ${(compressedSize/1024).toFixed(0)}KB (${reduction}% riduzione)`);
          
          resolve(compressedBase64);
        };
        
        img.onerror = () => reject(new Error('Errore caricamento immagine'));
        img.src = e.target.result;
      };
      
      reader.onerror = () => reject(new Error('Errore lettura file'));
      reader.readAsDataURL(file);
    });
  }
  
  /**
   * Controlla se √® possibile aggiungere altre foto
   * @param {string} section - 'checklist' o 'documentazione'
   * @returns {boolean}
   */
  function canAddPhoto(section) {
    if (section === 'checklist') {
      const fotoCount = state.checklist.filter(c => c.immagine).length;
      if (fotoCount >= MAX_FOTO_CHECKLIST) {
        alert(`‚ö†Ô∏è Limite raggiunto!\n\nPuoi caricare massimo ${MAX_FOTO_CHECKLIST} foto nella Checklist.\n\nMotivo: Limite memoria browser (localStorage).`);
        return false;
      }
    } else if (section === 'documentazione') {
      const fotoCount = state.foto.filter(f => f.immagine).length;
      if (fotoCount >= MAX_FOTO_DOCUMENTAZIONE) {
        alert(`‚ö†Ô∏è Limite raggiunto!\n\nPuoi caricare massimo ${MAX_FOTO_DOCUMENTAZIONE} foto nella Documentazione.\n\nMotivo: Limite memoria browser (localStorage).`);
        return false;
      }
    }
    return true;
  }
  
  // ========== FINE COMPRESSIONE ==========
  
  const defaultState = {
    dataDoc:todayISO(), autore:'', progettoShort:'',
    progetto:'', codiceCommessa:'', comune:'', indirizzo:'', provincia:'', committente:'', impresa:'', rup:'',
    dataVerbale:'', oraInizio:'', oraFine:'', coordinate:'',
    meteo:'', temperatura:'', visibilita:'', noteMeteo:'',
    stato:'',
    partecipanti:[],
    aree:{},
    lavorazioni:{},
    statoLavori:'', aspettiPositivi:'', criticita:'',
    checklist:[
      {voce:'Segnaletica di sicurezza presente e visibile', esito:'', note:'', fotoId:'', immagine:null},
      {voce:'DPI adeguati e utilizzati correttamente', esito:'', note:'', fotoId:'', immagine:null},
      {voce:'Ponteggi e parapetti conformi', esito:'', note:'', fotoId:'', immagine:null},
      {voce:'Protezioni aperture/scale', esito:'', note:'', fotoId:'', immagine:null},
      {voce:'Stoccaggi materiali ordinati e sicuri', esito:'', note:'', fotoId:'', immagine:null},
      {voce:'Documenti a pi√® d\'opera (POS, PSC, verbali)', esito:'', note:'', fotoId:'', immagine:null},
      {voce:'Tracciamenti e quote verificate', esito:'', note:'', fotoId:'', immagine:null},
      {voce:'Tolleranze lavorazioni entro limiti', esito:'', note:'', fotoId:'', immagine:null},
      {voce:'Pulizia e ordine aree di lavoro', esito:'', note:'', fotoId:'', immagine:null},
      {voce:'Smaltimento rifiuti e differenziazione', esito:'', note:'', fotoId:'', immagine:null}
    ],
    nonConformita:[], raci:[], foto:[],
    allegati:{}, allegatiAltro:'',
    noteFinali:'',
    firmaDL:null, firmaIMP:null,
    firmeAggiuntive:[]
  };
  
  let state = {...defaultState};
  try{
    const saved = localStorage.getItem(STORAGE);
    if(saved) Object.assign(state, JSON.parse(saved));
  }catch(e){console.log('No saved state');}
  
  function save(){ localStorage.setItem(STORAGE, JSON.stringify(state)); }
  
  // Funzione per aggiornare tutte le visualizzazioni dopo il load
  function refreshAll(){
    console.log('üîÑ refreshAll chiamata');
    console.log('üì¶ State checklist:', state.checklist);
    console.log('üì¶ State foto:', state.foto);
    
    if(typeof renderPart === 'function') { 
      console.log('‚úÖ Chiamando renderPart'); 
      renderPart(); 
    }
    if(typeof renderChecklist === 'function') { 
      console.log('‚úÖ Chiamando renderChecklist'); 
      renderChecklist(); 
    }
    if(typeof renderNC === 'function') { 
      console.log('‚úÖ Chiamando renderNC'); 
      renderNC(); 
    }
    if(typeof renderRaci === 'function') { 
      console.log('‚úÖ Chiamando renderRaci'); 
      renderRaci(); 
    }
    if(typeof renderFoto === 'function') { 
      console.log('‚úÖ Chiamando renderFoto'); 
      renderFoto(); 
    }
    if(typeof renderFirmeAggiuntive === 'function') { 
      console.log('‚úÖ Chiamando renderFirmeAggiuntive'); 
      renderFirmeAggiuntive(); 
    }
    if(typeof calcRiepilogo === 'function') { 
      console.log('‚úÖ Chiamando calcRiepilogo'); 
      calcRiepilogo(); 
    }
    if(typeof renderStatus === 'function') { 
      console.log('‚úÖ Chiamando renderStatus'); 
      renderStatus(); 
    }
    console.log('‚úÖ refreshAll completata');
  }
  
  // Helper per pulsanti mobile - aggiunge sia click che touch
  function addMobileClickHandler(elementId, handler, logMessage) {
    const element = $(elementId);
    if (!element) {
      console.error(`‚ùå Elemento non trovato: ${elementId}`);
      return;
    }
    
    element.addEventListener('click', (e) => {
      e.preventDefault();
      if (logMessage) console.log(logMessage);
      handler(e);
    });
    
    // Aggiungi anche touchend per mobile
    element.addEventListener('touchend', (e) => {
      e.preventDefault();
      if (logMessage) console.log(logMessage + ' (touch)');
      handler(e);
    }, { passive: false });
    
    console.log(`‚úÖ Handler registrato per: ${elementId}`);
  }
  
  // Bind simple fields
  const simpleFields = ['dataDoc','autore','progettoShort','progetto','codiceCommessa','comune','indirizzo','provincia','committente','impresa','rup','dataVerbale','oraInizio','oraFine','coordinate','meteo','temperatura','visibilita','noteMeteo','statoLavori','aspettiPositivi','criticita','noteFinali'];
  simpleFields.forEach(f=>{
    const el=$(f);
    if(el){
      el.value = state[f]||'';
      el.addEventListener('input',()=>{ state[f]=el.value; save(); calcRiepilogo(); renderStatus(); });
    }
  });
  
  // Stato cantiere
  document.querySelectorAll('input[name="stato"]').forEach(r=>{
    if(r.value===state.stato) r.checked=true;
    r.addEventListener('change',()=>{ state.stato=r.value; save(); });
  });
  
  // Partecipanti
  const partWrap = $('partecipanti');
  const ruoliPredefiniti = ['Progettista','Cliente','Impresa','DL','CSE','Direttore Tecnico','Sub Appaltatore','RUP','Altro'];
  function renderPart(){
    partWrap.innerHTML='';
    state.partecipanti.forEach((p,i)=>{
      const row = document.createElement('div');
      row.className='grid';
      row.style.gridTemplateColumns='1fr 1fr 1fr 1fr auto';
      row.style.gap='16px';
      row.style.alignItems='end';
      row.style.marginBottom='12px';
      
      // Nome
      const labelNome = document.createElement('label');
      labelNome.textContent='Nome *';
      const inputNome = document.createElement('input');
      inputNome.value = p.nome;
      inputNome.placeholder = 'Nome cognome';
      inputNome.addEventListener('input',()=>{ state.partecipanti[i].nome = inputNome.value; save(); renderStatus(); });
      labelNome.appendChild(inputNome);
      
      // Ruolo (select)
      const labelRuolo = document.createElement('label');
      labelRuolo.textContent='Ruolo *';
      const selectRuolo = document.createElement('select');
      selectRuolo.innerHTML = '<option value="">Seleziona...</option>' + ruoliPredefiniti.map(r=>`<option value="${r}">${r}</option>`).join('');
      selectRuolo.value = p.ruolo;
      selectRuolo.addEventListener('change',()=>{ state.partecipanti[i].ruolo = selectRuolo.value; save(); renderStatus(); });
      labelRuolo.appendChild(selectRuolo);
      
      // Societ√†
      const labelSocieta = document.createElement('label');
      labelSocieta.textContent='Societ√†';
      const inputSocieta = document.createElement('input');
      inputSocieta.value = p.societa;
      inputSocieta.placeholder = 'Ragione sociale';
      inputSocieta.addEventListener('input',()=>{ state.partecipanti[i].societa = inputSocieta.value; save(); });
      labelSocieta.appendChild(inputSocieta);
      
      // Email
      const labelEmail = document.createElement('label');
      labelEmail.textContent='Email';
      const inputEmail = document.createElement('input');
      inputEmail.type = 'email';
      inputEmail.value = p.email;
      inputEmail.placeholder = 'email@esempio.it';
      inputEmail.addEventListener('input',()=>{ state.partecipanti[i].email = inputEmail.value; save(); });
      labelEmail.appendChild(inputEmail);
      
      // Pulsante rimuovi (solo icona)
      const delBtn = document.createElement('button');
      delBtn.textContent='üóëÔ∏è';
      delBtn.className='ghost';
      delBtn.title='Rimuovi partecipante';
      delBtn.style.padding='10px 12px';
      delBtn.onclick=()=>{ state.partecipanti.splice(i,1); renderPart(); save(); renderStatus(); };
      
      row.appendChild(labelNome);
      row.appendChild(labelRuolo);
      row.appendChild(labelSocieta);
      row.appendChild(labelEmail);
      row.appendChild(delBtn);
      partWrap.appendChild(row);
    });
  }
  // renderPart(); // Commentato - verr√† chiamato da refreshAll() dopo il load dello state
  
  // Esponi funzioni globalmente per onclick inline (mobile-friendly)
  window.handleAddPartecipante = () => {
    console.log('üîò handleAddPartecipante chiamata');
    state.partecipanti.push({nome:'',ruolo:'',societa:'',email:''});
    renderPart();
    save();
  };
  console.log('‚úÖ handleAddPartecipante esposta:', typeof window.handleAddPartecipante);
  
  // Aree ispezionate
  const areeList = ['Strutture','Impianti elettrici','Impianti idraulici','Finiture','Esterni','Coperture','Fondazioni','Sicurezza','Magazzino','Uffici cantiere','Viabilit√†','Zone stoccaggio'];
  const areeWrap = $('areeChips');
  areeList.forEach(a=>{
    const lab=document.createElement('label');
    const inp=document.createElement('input');
    inp.type='checkbox';
    inp.checked=!!state.aree[a];
    inp.onchange=()=>{ state.aree[a]=inp.checked; save(); renderStatus(); };
    lab.appendChild(inp);
    lab.appendChild(document.createTextNode(' '+a));
    areeWrap.appendChild(lab);
  });
  
  // Lavorazioni
  const lavList = ['Demolizioni','Scavi','Fondazioni','Murature','Carpenteria','Solai','Coperture','Impermeabilizzazioni','Impianti','Finiture','Pitture','Pavimenti','Infissi','Cartongesso'];
  const lavWrap = $('lavorazioniChips');
  lavList.forEach(l=>{
    const lab=document.createElement('label');
    const inp=document.createElement('input');
    inp.type='checkbox';
    inp.checked=!!state.lavorazioni[l];
    inp.onchange=()=>{ state.lavorazioni[l]=inp.checked; save(); renderStatus(); };
    lab.appendChild(inp);
    lab.appendChild(document.createTextNode(' '+l));
    lavWrap.appendChild(lab);
  });
  
  // Checklist Qualit√† & Sicurezza
  const checklistWrap = $('checklistTable');
  function renderChecklist(){
    console.log('üîç renderChecklist chiamata');
    console.log('üìã Checklist items:', state.checklist.length);
    state.checklist.forEach((item, idx) => {
      if(item.immagine) {
        console.log(`‚úÖ Item ${idx} ha immagine:`, item.voce.substring(0, 30));
      }
    });
    
    checklistWrap.innerHTML='';
    
    // Aggiungi counter foto
    const fotoCount = state.checklist.filter(c => c.immagine).length;
    const counterDiv = document.createElement('div');
    counterDiv.style.cssText = 'background:#f0fdf4;border:1px solid #86efac;border-radius:6px;padding:8px 12px;margin-bottom:12px;font-size:13px;color:#166534';
    counterDiv.innerHTML = `üì∏ Foto caricate: <strong>${fotoCount}/${FOTO_CONFIG.MAX_FOTO_CHECKLIST}</strong> ${fotoCount > FOTO_CONFIG.MAX_FOTO_CHECKLIST * 0.8 ? '‚ö†Ô∏è Vicino al limite!' : ''}`;
    checklistWrap.appendChild(counterDiv);
    
    const head = document.createElement('div');
    head.className='row head';
    head.style.gridTemplateColumns='2fr 1fr 2fr 80px auto';
    head.innerHTML='<div>Voce</div><div>Esito</div><div>Note</div><div>Foto</div><div></div>';
    checklistWrap.appendChild(head);
    
    state.checklist.forEach((r,i)=>{
      const row = document.createElement('div');
      row.className='row';
      row.style.gridTemplateColumns='2fr 1fr 2fr 80px auto';
      row.style.alignItems='center';
      
      const voce = document.createElement('input');
      voce.value=r.voce;
      voce.placeholder='Descrivi la voce da verificare...';
      voce.oninput=()=>{r.voce=voce.value; save();};
      
      const esito = document.createElement('select');
      esito.innerHTML='<option value=""></option><option>‚úÖ Conforme</option><option>‚ùå NC</option><option>‚ûñ N/A</option>';
      esito.value=r.esito;
      esito.onchange=()=>{r.esito=esito.value; save();};
      
      const note = document.createElement('input');
      note.value=r.note;
      note.placeholder='Eventuali osservazioni...';
      note.oninput=()=>{r.note=note.value; save();};
      
      // Container foto con upload
      const fotoContainer = document.createElement('div');
      fotoContainer.style.cssText='position:relative;width:70px;height:70px';
      
      if(r.immagine){
        // Mostra miniatura
        const img = document.createElement('img');
        img.src = r.immagine;
        img.style.cssText='width:100%;height:100%;object-fit:cover;border-radius:6px;border:2px solid #e2e8f0;cursor:pointer';
        img.title='Click per cambiare foto';
        img.onclick=async()=>{
          const input = document.createElement('input');
          input.type='file';
          input.accept='image/*';
          input.capture='environment';
          input.onchange=async(e)=>{
            const file = e.target.files[0];
            if(file){
              try {
                // Mostra indicatore caricamento
                img.style.opacity = '0.5';
                img.title = 'Compressione in corso...';
                
                // Comprimi immagine
                const compressed = await compressImage(file);
                
                r.immagine = compressed;
                r.fotoId = file.name;
                save();
                renderChecklist();
              } catch(error) {
                console.error('Errore compressione:', error);
                alert('Errore durante il caricamento della foto. Riprova.');
                img.style.opacity = '1';
              }
            }
          };
          input.click();
        };
        fotoContainer.appendChild(img);
      } else {
        // Pulsante carica foto
        const uploadBtn = document.createElement('button');
        uploadBtn.className='ghost';
        uploadBtn.textContent='üì∑';
        uploadBtn.title='Carica foto';
        uploadBtn.style.cssText='width:100%;height:100%;border:2px dashed #cbd5e0;border-radius:6px;font-size:20px';
        uploadBtn.onclick=async()=>{
          // Controlla limite foto
          const fotoCount = state.checklist.filter(c => c.immagine).length;
          if (fotoCount >= FOTO_CONFIG.MAX_FOTO_CHECKLIST) {
            alert(`‚ö†Ô∏è Limite raggiunto!\n\nPuoi caricare massimo ${FOTO_CONFIG.MAX_FOTO_CHECKLIST} foto nella Checklist.\n\nMotivo: Evitare perdita dati per limite memoria browser.\n\nSuggerimento: Esporta il PDF e inizia un nuovo verbale.`);
            return;
          }
          
          const input = document.createElement('input');
          input.type='file';
          input.accept='image/*';
          input.capture='environment';
          input.onchange=async(e)=>{
            const file = e.target.files[0];
            if(file){
              try {
                // Mostra indicatore
                uploadBtn.textContent = '‚è≥';
                uploadBtn.disabled = true;
                
                // Comprimi immagine
                const compressed = await compressImage(
                  file, 
                  FOTO_CONFIG.MAX_WIDTH, 
                  FOTO_CONFIG.MAX_HEIGHT, 
                  FOTO_CONFIG.QUALITY
                );
                
                r.immagine = compressed;
                r.fotoId = file.name;
                save();
                checkStorageLimit();
                renderChecklist();
              } catch(error) {
                console.error('Errore compressione:', error);
                alert('Errore durante il caricamento della foto. Riprova.');
                uploadBtn.textContent = 'üì∑';
                uploadBtn.disabled = false;
              }
            }
          };
          input.click();
        };
        fotoContainer.appendChild(uploadBtn);
      }
      
      const del = document.createElement('button');
      del.className='secondary';
      del.textContent='üóëÔ∏è';
      del.onclick=()=>{ state.checklist.splice(i,1); renderChecklist(); save(); };
      
      row.append(voce, esito, note, fotoContainer, del);
      checklistWrap.appendChild(row);
    });
  }
  // renderChecklist(); // Commentato - verr√† chiamato da refreshAll() dopo il load dello state
  
  window.handleAddChecklist = () => {
    console.log('üîò handleAddChecklist chiamata');
    state.checklist.push({voce:'', esito:'', note:'', fotoId:'', immagine:null});
    renderChecklist();
    save();
  };
  
  // Non conformit√†
  function within7days(scad,base){
    if(!scad||!base) return false;
    const d1=new Date(scad), d2=new Date(base);
    return (d1-d2)/(1000*60*60*24) <= 7;
  }
  function priorita(grav,scad,base){
    if(!grav) return '';
    if(within7days(scad,base)) return 'ALTA';
    return grav;
  }
  
  const ncWrap = $('ncTable');
  function renderNC(){
    ncWrap.innerHTML='';
    const head=document.createElement('div');
    head.className='row head';
    head.style.gridTemplateColumns='2fr 1fr 1fr 1fr 1fr auto';
    head.innerHTML='<div>Descrizione</div><div>Gravit√†</div><div>Responsabile</div><div>Azione</div><div>Scadenza</div><div></div>';
    ncWrap.appendChild(head);
    
    state.nonConformita.forEach((r,i)=>{
      const row = document.createElement('div');
      row.className='row';
      row.style.gridTemplateColumns='2fr 1fr 1fr 1fr 1fr auto';
      
      const descr = document.createElement('textarea');
      descr.value=r.descr;
      descr.placeholder='Descrivi la non conformit√†...';
      descr.oninput=()=>{r.descr=descr.value; save();};
      
      const grav = document.createElement('select');
      grav.innerHTML='<option value=""></option><option>Bassa</option><option>Media</option><option>Alta</option>';
      grav.value=r.gravita;
      grav.onchange=()=>{ r.gravita=grav.value; r.priorita=priorita(r.gravita,r.scadenza,state.dataVerbale); save(); };
      
      const resp = document.createElement('input');
      resp.value=r.responsabile;
      resp.placeholder='Nome';
      resp.oninput=()=>{r.responsabile=resp.value; save();};
      
      const az = document.createElement('input');
      az.value=r.azione;
      az.placeholder='Azione correttiva';
      az.oninput=()=>{r.azione=az.value; save();};
      
      const sc = document.createElement('input');
      sc.type='date';
      sc.value=r.scadenza;
      sc.onchange=()=>{ r.scadenza=sc.value; r.priorita=priorita(r.gravita,r.scadenza,state.dataVerbale); save(); calcRiepilogo(); };
      
      const del = document.createElement('button');
      del.className='secondary';
      del.textContent='üóëÔ∏è';
      del.onclick=()=>{ state.nonConformita.splice(i,1); renderNC(); calcRiepilogo(); save(); };
      
      row.append(descr, grav, resp, az, sc, del);
      ncWrap.appendChild(row);
    });
  }
  // renderNC(); // Commentato - verr√† chiamato da refreshAll() dopo il load dello state
  
  window.handleAddNC = () => {
    console.log('üîò handleAddNC chiamata');
    state.nonConformita.push({descr:'', gravita:'', responsabile:'', azione:'', scadenza:'', priorita:''});
    renderNC();
    save();
  };
  
  // RACI
  const raciWrap = $('raciTable');
  function renderRACI(){
    raciWrap.innerHTML='';
    const head=document.createElement('div');
    head.className='row head';
    head.style.gridTemplateColumns='2fr 1fr 1fr 1fr auto';
    head.innerHTML='<div>Cosa</div><div>Responsabile</div><div>Supporto</div><div>Data Limite</div><div></div>';
    raciWrap.appendChild(head);
    
    state.raci.forEach((r,i)=>{
      const row=document.createElement('div');
      row.className='row';
      row.style.gridTemplateColumns='2fr 1fr 1fr 1fr auto';
      
      const cosa=document.createElement('input');
      cosa.value=r.cosa;
      cosa.placeholder='Descrivi azione...';
      cosa.oninput=()=>{r.cosa=cosa.value; save();};
      
      const resp=document.createElement('input');
      resp.value=r.responsabile;
      resp.placeholder='Nome responsabile';
      resp.oninput=()=>{r.responsabile=resp.value; save();};
      
      const sup=document.createElement('input');
      sup.value=r.supporto;
      sup.placeholder='Nome supporto';
      sup.oninput=()=>{r.supporto=sup.value; save();};
      
      const dl=document.createElement('input');
      dl.type='date';
      dl.value=r.dataLimite;
      dl.onchange=()=>{r.dataLimite=dl.value; save();};
      
      const del=document.createElement('button');
      del.className='secondary';
      del.textContent='üóëÔ∏è';
      del.onclick=()=>{ state.raci.splice(i,1); renderRACI(); save(); };
      
      row.append(cosa,resp,sup,dl,del);
      raciWrap.appendChild(row);
    });
  }
  renderRACI();
  
  window.handleAddRACI = () => {
    console.log('üîò handleAddRACI chiamata');
    state.raci.push({cosa:'',responsabile:'',supporto:'',dataLimite:'',esitoPrevisto:''});
    renderRACI();
    save();
  };
  
  // Foto
  const fotoWrap = $('fotoTable');
  function renderFoto(){
    console.log('üì∏ renderFoto chiamata');
    console.log('üì∑ Foto items:', state.foto.length);
    state.foto.forEach((item, idx) => {
      if(item.immagine) {
        console.log(`‚úÖ Foto ${idx} ha immagine:`, item.id || 'senza ID');
      }
    });
    
    fotoWrap.innerHTML='';
    
    // Aggiungi counter foto
    const fotoCount = state.foto.filter(f => f.immagine).length;
    const counterDiv = document.createElement('div');
    counterDiv.style.cssText = 'background:#f0fdf4;border:1px solid #86efac;border-radius:6px;padding:8px 12px;margin-bottom:12px;font-size:13px;color:#166534';
    counterDiv.innerHTML = `üì∏ Foto caricate: <strong>${fotoCount}/${FOTO_CONFIG.MAX_FOTO_DOCUMENTAZIONE}</strong> ${fotoCount > FOTO_CONFIG.MAX_FOTO_DOCUMENTAZIONE * 0.8 ? '‚ö†Ô∏è Vicino al limite!' : ''}`;
    fotoWrap.appendChild(counterDiv);
    
    const head=document.createElement('div');
    head.className='row head';
    head.style.gridTemplateColumns='120px 1fr 2fr auto';
    head.innerHTML='<div>Foto</div><div>Posizione</div><div>Nota</div><div></div>';
    fotoWrap.appendChild(head);
    
    state.foto.forEach((r,i)=>{
      const row=document.createElement('div');
      row.className='row';
      row.style.gridTemplateColumns='120px 1fr 2fr auto';
      row.style.alignItems='center';
      
      // Container foto con upload
      const fotoContainer=document.createElement('div');
      fotoContainer.style.cssText='position:relative;width:100px;height:100px';
      
      if(r.immagine){
        // Mostra anteprima
        const img=document.createElement('img');
        img.src=r.immagine;
        img.style.cssText='width:100%;height:100%;object-fit:cover;border-radius:8px;border:2px solid #e2e8f0';
        fotoContainer.appendChild(img);
        
        // Pulsante cambia foto
        const changeBtn=document.createElement('button');
        changeBtn.className='ghost';
        changeBtn.textContent='üì∑';
        changeBtn.title='Cambia foto';
        changeBtn.style.cssText='position:absolute;bottom:2px;right:2px;padding:4px 8px;font-size:12px';
        changeBtn.onclick=async()=>{
          const input=document.createElement('input');
          input.type='file';
          input.accept='image/*';
          input.capture='environment';
          input.onchange=async(e)=>{
            const file=e.target.files[0];
            if(file){
              try {
                changeBtn.textContent='‚è≥';
                changeBtn.disabled=true;
                
                const compressed = await compressImage(
                  file,
                  FOTO_CONFIG.MAX_WIDTH,
                  FOTO_CONFIG.MAX_HEIGHT,
                  FOTO_CONFIG.QUALITY
                );
                
                r.immagine=compressed;
                r.id=file.name;
                save();
                renderFoto();
              } catch(error) {
                console.error('Errore compressione:', error);
                alert('Errore durante il caricamento della foto. Riprova.');
                changeBtn.textContent='üì∑';
                changeBtn.disabled=false;
              }
            }
          };
          input.click();
        };
        fotoContainer.appendChild(changeBtn);
      }else{
        // Pulsante aggiungi foto
        const uploadBtn=document.createElement('button');
        uploadBtn.className='secondary';
        uploadBtn.textContent='üì∑ Carica';
        uploadBtn.style.cssText='width:100%;height:100%;border:2px dashed #cbd5e0;border-radius:8px';
        uploadBtn.onclick=async()=>{
          // Controlla limite foto
          const fotoCount = state.foto.filter(f => f.immagine).length;
          if (fotoCount >= FOTO_CONFIG.MAX_FOTO_DOCUMENTAZIONE) {
            alert(`‚ö†Ô∏è Limite raggiunto!\n\nPuoi caricare massimo ${FOTO_CONFIG.MAX_FOTO_DOCUMENTAZIONE} foto nella Documentazione Fotografica.\n\nMotivo: Evitare perdita dati per limite memoria browser.\n\nSuggerimento: Esporta il PDF e inizia un nuovo verbale.`);
            return;
          }
          
          const input=document.createElement('input');
          input.type='file';
          input.accept='image/*';
          input.capture='environment';
          input.onchange=async(e)=>{
            const file=e.target.files[0];
            if(file){
              try {
                uploadBtn.textContent='‚è≥';
                uploadBtn.disabled=true;
                
                const compressed = await compressImage(
                  file,
                  FOTO_CONFIG.MAX_WIDTH,
                  FOTO_CONFIG.MAX_HEIGHT,
                  FOTO_CONFIG.QUALITY
                );
                
                r.immagine=compressed;
                r.id=file.name;
                save();
                checkStorageLimit();
                renderFoto();
              } catch(error) {
                console.error('Errore compressione:', error);
                alert('Errore durante il caricamento della foto. Riprova.');
                uploadBtn.textContent='üì∑ Carica';
                uploadBtn.disabled=false;
              }
            }
          };
          input.click();
        };
        fotoContainer.appendChild(uploadBtn);
      }
      
      const pos=document.createElement('input');
      pos.value=r.posizione;
      pos.placeholder='Zona/Piano';
      pos.oninput=()=>{r.posizione=pos.value; save();};
      
      const nota=document.createElement('input');
      nota.value=r.nota;
      nota.placeholder='Descrizione breve';
      nota.oninput=()=>{r.nota=nota.value; save();};
      
      const del=document.createElement('button');
      del.className='secondary';
      del.textContent='üóëÔ∏è';
      del.onclick=()=>{ state.foto.splice(i,1); renderFoto(); save(); };
      
      row.append(fotoContainer,pos,nota,del);
      fotoWrap.appendChild(row);
    });
  }
  // renderFoto(); // Commentato - verr√† chiamato da refreshAll() dopo il load dello state
  
  window.handleAddFoto = () => {
    console.log('üîò handleAddFoto chiamata');
    state.foto.push({id:'',posizione:'',nota:'',immagine:null});
    renderFoto();
    save();
  };
  
  // Allegati
  const allegatiWrap = $('allegati');
  const allegatiList = ['Planimetrie','Sezioni/Profili','Schede tecniche','Relazioni','Verbali precedenti','Computo/Capitolato'];
  allegatiList.forEach(a=>{
    const lab=document.createElement('label');
    const inp=document.createElement('input');
    inp.type='checkbox';
    inp.checked=!!state.allegati[a];
    inp.onchange=()=>{ state.allegati[a]=inp.checked; save(); };
    lab.appendChild(inp);
    lab.appendChild(document.createTextNode(' '+a));
    allegatiWrap.appendChild(lab);
  });
  
  const altChk = $('allegatiAltroChk'), altTxt = $('allegatiAltro');
  if(altTxt){ altTxt.value = state.allegatiAltro || ''; altTxt.addEventListener('input', ()=>{ state.allegatiAltro = altTxt.value; save(); }); }
  if(altChk){ altChk.checked = !!state.allegatiAltro; altChk.addEventListener('change', ()=>{ if(!altChk.checked){ state.allegatiAltro=''; if(altTxt){ altTxt.value=''; } save(); } }); }
  
  // Riepilogo
  function calcRiepilogo(){
    const nc = state.nonConformita.filter(x=>x.descr.trim()).length;
    const presc = state.nonConformita.filter(x=>x.azione.trim()).length;
    const immin = state.nonConformita.filter(x=>x.scadenza && within7days(x.scadenza, state.dataVerbale)).length;
    $('riepilogoNc').textContent=nc;
    $('riepilogoPresc').textContent=presc;
    $('riepilogoScadenze').textContent=immin;
  }
  
  function isValid(){
    const base = !!(state.progetto && state.dataVerbale && state.comune && state.indirizzo && state.provincia && state.oraInizio && state.oraFine);
    const p = state.partecipanti.some(x=>x.nome.trim());
    const lavori = Object.values(state.lavorazioni).some(Boolean);
    return base && p && lavori;
  }
  
  function renderStatus(){
    const valid = isValid();
    const badge = $('status');
    badge.textContent = valid ? '‚úÖ Pronto all\'invio' : '‚ö†Ô∏è Dati incompleti';
    badge.className = valid ? 'status-badge valid' : 'status-badge invalid';
  }
  
  calcRiepilogo();
  renderStatus();
  
  // Export JSON
  $('btnExportJSON').addEventListener('click', (e) => {
    e.preventDefault();
    console.log('üíæ Click Salva JSON');
    
    // Crea copia dello state senza immagini
    const stateClean = JSON.parse(JSON.stringify(state));
    
    // Rimuovi immagini dalla checklist
    if (stateClean.checklist) {
      stateClean.checklist.forEach(item => {
        if (item.immagine) {
          // Mantieni solo info che c'√® una foto, non il base64
          item.hasFoto = true;
          delete item.immagine;
        }
      });
    }
    
    // Rimuovi immagini dalla documentazione fotografica
    if (stateClean.foto) {
      stateClean.foto.forEach(foto => {
        if (foto.immagine) {
          foto.hasFoto = true;
          delete foto.immagine;
        }
      });
    }
    
    // Rimuovi firme (sono immagini grandi)
    if (stateClean.firmaDL) {
      stateClean.hasFirmaDL = true;
      delete stateClean.firmaDL;
    }
    if (stateClean.firmaIMP) {
      stateClean.hasFirmaIMP = true;
      delete stateClean.firmaIMP;
    }
    if (stateClean.firmeAggiuntive) {
      stateClean.numFirmeAggiuntive = stateClean.firmeAggiuntive.length;
      delete stateClean.firmeAggiuntive;
    }
    
    // Aggiungi metadati export
    stateClean._export = {
      versione: 'v2.1',
      data: new Date().toISOString(),
      nota: 'JSON ottimizzato per AI - immagini rimosse (vedi PDF)',
      fotoChecklist: stateClean.checklist?.filter(c => c.hasFoto).length || 0,
      fotoDocumentazione: stateClean.foto?.filter(f => f.hasFoto).length || 0
    };
    
    const blob = new Blob([JSON.stringify(stateClean, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href=URL.createObjectURL(blob);
    const file = `Verbale_${(state.progettoShort||'Progetto').replaceAll(' ','-')}_${state.dataVerbale||todayISO()}.json`;
    a.download = file;
    a.click();
    URL.revokeObjectURL(a.href);
    
    // Mostra info all'utente
    const sizeMB = (blob.size / (1024 * 1024)).toFixed(2);
    console.log(`üíæ JSON esportato senza immagini: ${sizeMB} MB`);
  });
  
  // Import JSON
  $('fileImport').addEventListener('change', (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = () => {
      try {
        const data = JSON.parse(String(r.result));
        Object.assign(state, data);
        localStorage.setItem(STORAGE, JSON.stringify(state));
        location.reload();
      } catch {
        alert('File JSON non valido');
      }
    };
    r.readAsText(f);
  });
  
  // Reset
  $('btnReset').addEventListener('click', (e) => {
    e.preventDefault();
    console.log('üîÑ Click Nuovo');
    if(confirm('Sei sicuro di voler creare un nuovo verbale? I dati attuali andranno persi.')) {
      localStorage.removeItem(STORAGE);
      location.reload();
    }
  });
  
  // Stampa
  $('btnPrint').addEventListener('click', (e) => {
    e.preventDefault();
    console.log('üñ®Ô∏è Click Stampa');
    window.print();
  });
  
  // Export PDF professionale - VERSIONE OTTIMIZZATA
  async function exportPDF() {
    if (!window.jspdf) {
      alert('Librerie PDF non disponibili. Usa "Stampa" come alternativa.');
      return;
    }
    
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    let yPos = 20;
    const pageWidth = 210, margin = 20, contentWidth = pageWidth - (margin * 2);
    
    const colors = {
      primary: [23, 162, 184],
      primaryLight: [224, 247, 250],
      secondary: [71, 85, 105],
      text: [15, 23, 42],
      textLight: [100, 116, 139],
      success: [34, 197, 94],
      danger: [239, 68, 68],
      border: [226, 232, 240]
    };
    
    function checkPageBreak(height = 10) {
      if (yPos + height > 277) { pdf.addPage(); yPos = 20; return true; }
      return false;
    }
    
    function addSeparator() {
      pdf.setDrawColor(colors.border[0], colors.border[1], colors.border[2]);
      pdf.setLineWidth(0.5);
      pdf.line(margin, yPos, pageWidth - margin, yPos);
      yPos += 5;
    }
    
    function addText(text, size = 10, style = 'normal', color = colors.text) {
      if(!text) return;
      pdf.setFontSize(size);
      pdf.setFont('helvetica', style);
      pdf.setTextColor(color[0], color[1], color[2]);
      const lines = pdf.splitTextToSize(text, contentWidth);
      checkPageBreak(lines.length * size * 0.4 + 2);
      pdf.text(lines, margin, yPos);
      yPos += lines.length * size * 0.4 + 2;
    }
    
    function addField(label, value, sameLine = false) {
      if(!value || value === 'N/D') return;
      checkPageBreak(6);
      pdf.setFontSize(9);
      pdf.setFont('helvetica', 'bold');
      pdf.setTextColor(colors.secondary[0], colors.secondary[1], colors.secondary[2]);
      
      if(sameLine) {
        pdf.text(label + ':', margin, yPos);
        pdf.setFont('helvetica', 'normal');
        pdf.setTextColor(colors.text[0], colors.text[1], colors.text[2]);
        pdf.text(value, margin + 45, yPos);
        yPos += 5;
      } else {
        pdf.text(label, margin, yPos);
        yPos += 4;
        pdf.setFont('helvetica', 'normal');
        pdf.setTextColor(colors.text[0], colors.text[1], colors.text[2]);
        const lines = pdf.splitTextToSize(value, contentWidth - 5);
        pdf.text(lines, margin + 5, yPos);
        yPos += lines.length * 3.5 + 3;
      }
    }
    
    function addInfoBox(content, bgColor = colors.primaryLight) {
      checkPageBreak(15);
      pdf.setFillColor(bgColor[0], bgColor[1], bgColor[2]);
      pdf.roundedRect(margin, yPos - 2, contentWidth, 8, 2, 2, 'F');
      pdf.setFontSize(9);
      pdf.setFont('helvetica', 'normal');
      pdf.setTextColor(colors.text[0], colors.text[1], colors.text[2]);
      pdf.text(content, margin + 3, yPos + 3);
      yPos += 11;
    }
    
    function addSectionHeader(number, text) {
      checkPageBreak(12);
      pdf.setFillColor(colors.primary[0], colors.primary[1], colors.primary[2]);
      pdf.roundedRect(margin, yPos, 10, 8, 1, 1, 'F');
      pdf.setFontSize(11);
      pdf.setFont('helvetica', 'bold');
      pdf.setTextColor(255, 255, 255);
      pdf.text(number, margin + 3, yPos + 5.5);
      pdf.setFontSize(12);
      pdf.setTextColor(colors.primary[0], colors.primary[1], colors.primary[2]);
      pdf.text(text.toUpperCase(), margin + 13, yPos + 5.5);
      yPos += 12;
    }
    
    // Helper per aggiungere immagini mantenendo proporzioni
    function addImageWithAspectRatio(imgData, maxWidth, maxHeight) {
      try {
        // Estrae tipo e dati dall'immagine base64
        const matches = imgData.match(/^data:image\/(\w+);base64,(.*)$/);
        if (!matches) {
          throw new Error('Invalid image data');
        }
        
        const imageType = matches[1].toUpperCase();
        const format = imageType === 'JPG' ? 'JPEG' : imageType;
        
        // jsPDF pu√≤ determinare automaticamente le dimensioni, ma forziamo un aspect ratio ragionevole
        // Proviamo ad aggiungere l'immagine e jsPDF gestir√† le dimensioni
        const imgProps = pdf.getImageProperties(imgData);
        const ratio = imgProps.width / imgProps.height;
        
        let width = maxWidth;
        let height = maxHeight;
        
        if(ratio > maxWidth / maxHeight) {
          // Immagine pi√π larga - limita larghezza
          width = maxWidth;
          height = maxWidth / ratio;
        } else {
          // Immagine pi√π alta - limita altezza  
          height = maxHeight;
          width = maxHeight * ratio;
        }
        
        pdf.addImage(imgData, format, margin, yPos, width, height);
        yPos += height + 3;
        return true;
      } catch(e) {
        console.error('Errore caricamento immagine:', e);
        pdf.setFontSize(9);
        pdf.setFont('helvetica', 'italic');
        pdf.setTextColor(colors.textLight[0], colors.textLight[1], colors.textLight[2]);
        pdf.text('[Immagine non disponibile]', margin, yPos);
        yPos += 5;
        return false;
      }
    }
    
    // Header documento
    pdf.setFillColor(colors.primary[0], colors.primary[1], colors.primary[2]);
    pdf.rect(0, 0, pageWidth, 45, 'F');
    pdf.setFontSize(24);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(255, 255, 255);
    pdf.text('VERBALE DI SOPRALLUOGO', margin, 20);
    pdf.setFontSize(11);
    pdf.setFont('helvetica', 'normal');
    pdf.text(`${state.progetto || 'Progetto'} - ${state.dataVerbale || 'N/D'}`, margin, 28);
    
    yPos = 55;
    addInfoBox(`Generato: ${new Date().toLocaleDateString('it-IT')} | Autore: ${state.autore || 'N/D'} | Codice: ${state.progettoShort || 'N/D'}`, [240, 249, 255]);
    yPos += 2;
    
    // 1. Intestazione
    addSectionHeader('1', 'Intestazione Cantiere');
    if(state.progetto) addField('Progetto', state.progetto, true);
    if(state.codiceCommessa) addField('Codice/Commessa', state.codiceCommessa, true);
    if(state.comune || state.indirizzo || state.provincia) {
      const indCompleto = [state.comune, state.indirizzo, state.provincia ? `(${state.provincia})` : ''].filter(Boolean).join(', ');
      addField('Indirizzo completo', indCompleto, true);
    }
    if(state.committente) addField('Committente', state.committente, true);
    if(state.impresa) addField('Impresa', state.impresa, true);
    if(state.rup) addField('RUP', state.rup, true);
    if(state.dataVerbale) addField('Data Sopralluogo', state.dataVerbale, true);
    if(state.oraInizio && state.oraFine) addField('Orario', `${state.oraInizio} - ${state.oraFine}`, true);
    if(state.coordinate) addField('Coordinate GPS', state.coordinate, true);
    yPos += 3; addSeparator();
    
    // 2. Meteo
    addSectionHeader('2', 'Condizioni Meteo e Ambientali');
    const meteoData = [];
    if(state.meteo) meteoData.push(`Condizioni: ${state.meteo.replace(/[^\x00-\x7F]/g, '')}`);
    if(state.temperatura) meteoData.push(`Temperatura: ${state.temperatura} gradi C`);
    if(state.visibilita) meteoData.push(`Visibilita: ${state.visibilita}`);
    if(meteoData.length > 0) addText(meteoData.join(' | '), 9, 'normal', colors.textLight);
    if(state.noteMeteo) addField('Note Meteo', state.noteMeteo);
    if(state.stato) addField('Stato Cantiere', state.stato.toUpperCase(), true);
    yPos += 3; addSeparator();
    
    // 3. Partecipanti
    addSectionHeader('3', 'Partecipanti');
    if(state.partecipanti && state.partecipanti.length > 0) {
      state.partecipanti.forEach(p => {
        if(p.nome) {
          let partText = `${p.nome}`;
          if(p.ruolo) partText += ` - ${p.ruolo}`;
          if(p.societa) partText += ` (${p.societa})`;
          addText('- ' + partText, 9, 'normal', colors.text);
        }
      });
    }
    yPos += 3; addSeparator();
    
    // 4. Aree
    addSectionHeader('4', 'Aree Ispezionate');
    const aree = Object.keys(state.aree || {}).filter(k => state.aree[k]);
    if(aree.length > 0) addText(aree.join(', '), 9);
    yPos += 3; addSeparator();
    
    // 5. Lavorazioni
    addSectionHeader('5', 'Lavorazioni in Corso');
    const lav = Object.keys(state.lavorazioni || {}).filter(k => state.lavorazioni[k]);
    if(lav.length > 0) addText(lav.join(', '), 9);
    yPos += 3; addSeparator();
    
    // 6. Osservazioni
    addSectionHeader('6', 'Osservazioni Generali');
    if(state.statoLavori) addField('Stato Lavori', state.statoLavori);
    if(state.aspettiPositivi) addField('Aspetti Positivi', state.aspettiPositivi);
    if(state.criticita) addField('Criticita', state.criticita);
    yPos += 3; addSeparator();
    
    // 7. Checklist
    addSectionHeader('7', 'Check-list Qualita & Sicurezza');
    if(state.checklist && state.checklist.length > 0) {
      // Prima mostra la tabella con i dati
      const checkData = state.checklist.filter(c => c.voce).map(c => [
        c.voce.replace(/[^\x00-\x7F]/g, ''),
        (c.esito || '-').replace(/[^\x00-\x7F]/g, ''),
        c.note || '-',
        c.immagine ? 'Si' : '-'
      ]);
      if(checkData.length > 0) {
        checkPageBreak(30);
        pdf.autoTable({
          startY: yPos,
          head: [['Voce', 'Esito', 'Note', 'Foto']],
          body: checkData,
          theme: 'striped',
          styles: { fontSize: 8, cellPadding: 3, lineColor: colors.border, lineWidth: 0.1 },
          headStyles: { fillColor: colors.primary, textColor: [255, 255, 255], fontStyle: 'bold', halign: 'left' },
          alternateRowStyles: { fillColor: [248, 250, 252] },
          margin: { left: margin, right: margin },
          columnStyles: { 0: {cellWidth: 75}, 1: {cellWidth: 25, halign: 'center'}, 2: {cellWidth: 75}, 3: {cellWidth: 15, halign: 'center'} }
        });
        yPos = pdf.lastAutoTable.finalY + 8;
      }
      
      // Poi mostra le foto se presenti
      const checkConFoto = state.checklist.filter(c => c.immagine);
      if(checkConFoto.length > 0) {
        yPos += 3;
        addText('Foto di dettaglio checklist:', 9, 'bold', colors.secondary);
        yPos += 3;
        
        checkConFoto.forEach((c, idx) => {
          checkPageBreak(50);
          
          pdf.setFontSize(9);
          pdf.setFont('helvetica', 'bold');
          pdf.setTextColor(colors.text[0], colors.text[1], colors.text[2]);
          pdf.text(`${idx + 1}. ${c.voce}`, margin, yPos);
          yPos += 5;
          
          checkPageBreak(50);
          addImageWithAspectRatio(c.immagine, 60, 45);
          
          if(c.note) {
            pdf.setFontSize(8);
            pdf.setFont('helvetica', 'normal');
            pdf.setTextColor(colors.textLight[0], colors.textLight[1], colors.textLight[2]);
            const noteLines = pdf.splitTextToSize(`Nota: ${c.note}`, contentWidth);
            pdf.text(noteLines, margin, yPos);
            yPos += noteLines.length * 3 + 3;
          }
          
          yPos += 2;
        });
      }
    }
    addSeparator();
    
    // 8. Non Conformita
    addSectionHeader('8', 'Non Conformita e Prescrizioni');
    if(state.nonConformita && state.nonConformita.length > 0) {
      const ncData = state.nonConformita.filter(nc => nc.descr).map(nc => [
        nc.descr, nc.gravita || '-', nc.responsabile || '-', nc.azione || '-', nc.scadenza || '-'
      ]);
      if(ncData.length > 0) {
        checkPageBreak(30);
        pdf.autoTable({
          startY: yPos,
          head: [['Descrizione', 'Gravita', 'Responsabile', 'Azione Correttiva', 'Scadenza']],
          body: ncData,
          theme: 'striped',
          styles: { fontSize: 8, cellPadding: 3, lineColor: colors.border, lineWidth: 0.1 },
          headStyles: { fillColor: colors.danger, textColor: [255, 255, 255], fontStyle: 'bold', halign: 'left' },
          alternateRowStyles: { fillColor: [254, 242, 242] },
          margin: { left: margin, right: margin },
          columnStyles: { 0: {cellWidth: 50}, 1: {cellWidth: 20, halign: 'center'}, 2: {cellWidth: 30}, 3: {cellWidth: 50}, 4: {cellWidth: 25, halign: 'center'} }
        });
        yPos = pdf.lastAutoTable.finalY + 8;
      }
    }
    addSeparator();
    
    // 9. RACI
    addSectionHeader('9', 'Azioni e Responsabilita (RACI)');
    if(state.raci && state.raci.length > 0) {
      const raciData = state.raci.filter(r => r.cosa).map(r => [
        r.cosa, r.responsabile || '-', r.supporto || '-', r.dataLimite || '-'
      ]);
      if(raciData.length > 0) {
        checkPageBreak(30);
        pdf.autoTable({
          startY: yPos,
          head: [['Attivita', 'Responsabile', 'Supporto', 'Data Limite']],
          body: raciData,
          theme: 'striped',
          styles: { fontSize: 8, cellPadding: 3, lineColor: colors.border, lineWidth: 0.1 },
          headStyles: { fillColor: [59, 130, 246], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'left' },
          alternateRowStyles: { fillColor: [239, 246, 255] },
          margin: { left: margin, right: margin }
        });
        yPos = pdf.lastAutoTable.finalY + 8;
      }
    }
    addSeparator();
    
    // 10. Foto
    addSectionHeader('10', 'Documentazione Fotografica');
    if(state.foto && state.foto.length > 0) {
      const fotoConImmagine = state.foto.filter(f => f.immagine);
      
      if(fotoConImmagine.length > 0) {
        // Mostra le foto con immagini
        fotoConImmagine.forEach((f, idx) => {
          checkPageBreak(80); // Spazio per immagine + testo
          
          // Titolo foto
          pdf.setFontSize(10);
          pdf.setFont('helvetica', 'bold');
          pdf.setTextColor(colors.text[0], colors.text[1], colors.text[2]);
          pdf.text(`Foto ${idx + 1}${f.id ? ': ' + f.id : ''}`, margin, yPos);
          yPos += 6;
          
          // Immagine con proporzioni corrette
          checkPageBreak(70);
          addImageWithAspectRatio(f.immagine, 80, 60);
          
          // Dettagli sotto l'immagine
          pdf.setFontSize(9);
          pdf.setFont('helvetica', 'normal');
          pdf.setTextColor(colors.textLight[0], colors.textLight[1], colors.textLight[2]);
          if(f.posizione) {
            pdf.text(`Posizione: ${f.posizione}`, margin, yPos);
            yPos += 4;
          }
          if(f.nota) {
            const noteLines = pdf.splitTextToSize(`Nota: ${f.nota}`, contentWidth);
            pdf.text(noteLines, margin, yPos);
            yPos += noteLines.length * 4 + 5;
          }
          
          yPos += 3; // Spazio tra foto
        });
      }
      
      // Se ci sono foto senza immagine (solo con ID/nome), mostrali in tabella
      const fotoSenzaImmagine = state.foto.filter(f => !f.immagine && f.id);
      if(fotoSenzaImmagine.length > 0) {
        yPos += 5;
        addText('Altre foto (solo riferimenti):', 9, 'bold', colors.secondary);
        const fotoData = fotoSenzaImmagine.map(f => [f.id, f.posizione || '-', f.nota || '-']);
        checkPageBreak(30);
        pdf.autoTable({
          startY: yPos,
          head: [['Foto ID', 'Posizione', 'Descrizione']],
          body: fotoData,
          theme: 'striped',
          styles: { fontSize: 8, cellPadding: 3, lineColor: colors.border, lineWidth: 0.1 },
          headStyles: { fillColor: colors.success, textColor: [255, 255, 255], fontStyle: 'bold', halign: 'left' },
          alternateRowStyles: { fillColor: [240, 253, 244] },
          margin: { left: margin, right: margin },
          columnStyles: { 0: {cellWidth: 30, halign: 'center'}, 1: {cellWidth: 40}, 2: {cellWidth: 100} }
        });
        yPos = pdf.lastAutoTable.finalY + 8;
      }
    } else {
      addText('Nessuna foto documentata', 9, 'italic', colors.textLight);
      yPos += 3;
    }
    addSeparator();
    
    // 11. Allegati
    addSectionHeader('11', 'Allegati');
    const all = Object.keys(state.allegati || {}).filter(k => state.allegati[k]);
    if(all.length > 0 || state.allegatiAltro) {
      if(all.length > 0) addText(all.join(', '), 9);
      if(state.allegatiAltro) addText('Altro: ' + state.allegatiAltro, 9);
    }
    yPos += 3; addSeparator();
    
    // 12. Riepilogo
    addSectionHeader('12', 'Riepilogo Finale');
    const nc = (state.nonConformita || []).filter(x => x.descr && x.descr.trim()).length;
    const presc = (state.nonConformita || []).filter(x => x.azione && x.azione.trim()).length;
    checkPageBreak(20);
    pdf.setFillColor(colors.primaryLight[0], colors.primaryLight[1], colors.primaryLight[2]);
    pdf.roundedRect(margin, yPos, contentWidth, 15, 2, 2, 'F');
    pdf.setFontSize(11);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(colors.primary[0], colors.primary[1], colors.primary[2]);
    pdf.text(`Non Conformita: ${nc}`, margin + 5, yPos + 6);
    pdf.text(`Prescrizioni: ${presc}`, margin + 90, yPos + 6);
    yPos += 20;
    if(state.noteFinali) { addField('Note Conclusive', state.noteFinali); yPos += 3; }
    addSeparator();
    
    // Firme
    addSectionHeader('', 'Firme');
    yPos += 2;
    checkPageBreak(50);
    const firmaWidth = (contentWidth - 10) / 2;
    
    pdf.setFontSize(10);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(colors.text[0], colors.text[1], colors.text[2]);
    pdf.text('Direttore Lavori', margin, yPos);
    if(state.firmaDL) {
      try { pdf.addImage(state.firmaDL, 'PNG', margin, yPos + 3, firmaWidth - 10, 20); }
      catch(e) { pdf.setDrawColor(colors.border[0], colors.border[1], colors.border[2]); pdf.line(margin, yPos + 15, margin + firmaWidth - 10, yPos + 15); }
    } else {
      pdf.setDrawColor(colors.border[0], colors.border[1], colors.border[2]);
      pdf.line(margin, yPos + 15, margin + firmaWidth - 10, yPos + 15);
    }
    
    pdf.text('Impresa', margin + firmaWidth + 10, yPos);
    if(state.firmaIMP) {
      try { pdf.addImage(state.firmaIMP, 'PNG', margin + firmaWidth + 10, yPos + 3, firmaWidth - 10, 20); }
      catch(e) { pdf.setDrawColor(colors.border[0], colors.border[1], colors.border[2]); pdf.line(margin + firmaWidth + 10, yPos + 15, margin + contentWidth, yPos + 15); }
    } else {
      pdf.setDrawColor(colors.border[0], colors.border[1], colors.border[2]);
      pdf.line(margin + firmaWidth + 10, yPos + 15, margin + contentWidth, yPos + 15);
    }
    yPos += 30;
    
    // Firme aggiuntive
    if(state.firmeAggiuntive && state.firmeAggiuntive.length > 0) {
      state.firmeAggiuntive.forEach((f) => {
        if(f.label) {
          checkPageBreak(35);
          pdf.setFont('helvetica', 'bold');
          pdf.text(f.label, margin, yPos);
          if(f.firma) {
            try { pdf.addImage(f.firma, 'PNG', margin, yPos + 3, 70, 20); }
            catch(e) { pdf.setDrawColor(colors.border[0], colors.border[1], colors.border[2]); pdf.line(margin, yPos + 15, margin + 70, yPos + 15); }
          } else {
            pdf.setDrawColor(colors.border[0], colors.border[1], colors.border[2]);
            pdf.line(margin, yPos + 15, margin + 70, yPos + 15);
          }
          yPos += 30;
        }
      });
    }
    
    // Footer
    const pageCount = pdf.internal.getNumberOfPages();
    for(let i = 1; i <= pageCount; i++) {
      pdf.setPage(i);
      pdf.setDrawColor(colors.border[0], colors.border[1], colors.border[2]);
      pdf.setLineWidth(0.5);
      pdf.line(margin, 285, pageWidth - margin, 285);
      pdf.setFontSize(8);
      pdf.setFont('helvetica', 'normal');
      pdf.setTextColor(colors.textLight[0], colors.textLight[1], colors.textLight[2]);
      pdf.text(`${state.progetto || 'Verbale di sopralluogo'}`, margin, 290);
      pdf.text(`Pag. ${i} di ${pageCount}`, pageWidth / 2 - 10, 290);
      pdf.text(`${new Date().toLocaleDateString('it-IT')}`, pageWidth - margin - 20, 290);
    }
    
    pdf.save(`Verbale_${(state.progettoShort||'Progetto').replaceAll(' ','-')}_${state.dataVerbale||todayISO()}.pdf`);
  }
  
  // Funzione per inviare via email

  
  $('btnExportPDF').addEventListener('click', (e) => {
    e.preventDefault();
    console.log('üìÑ Click Esporta PDF');
    exportPDF();
  });
  $('btnExportPDFBottom').addEventListener('click', (e) => {
    e.preventDefault();
    console.log('üìÑ Click Esporta PDF (bottom)');
    exportPDF();
  });
  
  // Firme aggiuntive
  const firmeAggWrap = $('firmeAggiuntive');
  function renderFirmeAggiuntive(){
    firmeAggWrap.innerHTML='';
    state.firmeAggiuntive.forEach((f,i)=>{
      const container = document.createElement('div');
      container.style.cssText = 'margin-bottom:20px;padding:16px;background:#f7fafc;border-radius:12px;border:2px solid #e2e8f0';
      
      const headerDiv = document.createElement('div');
      headerDiv.style.cssText = 'display:flex;gap:12px;margin-bottom:12px;align-items:center';
      
      const labelInput = document.createElement('input');
      labelInput.placeholder = 'es. CSE, Progettista, RUP...';
      labelInput.value = f.label || '';
      labelInput.style.cssText = 'flex:1;border:2px solid #e2e8f0;border-radius:8px;padding:10px 12px;font-size:14px';
      labelInput.oninput = ()=>{ state.firmeAggiuntive[i].label = labelInput.value; save(); };
      
      const delBtn = document.createElement('button');
      delBtn.className = 'ghost';
      delBtn.textContent = 'üóëÔ∏è Rimuovi';
      delBtn.onclick = ()=>{ 
        state.firmeAggiuntive.splice(i,1); 
        renderFirmeAggiuntive(); 
        save(); 
      };
      
      headerDiv.appendChild(labelInput);
      headerDiv.appendChild(delBtn);
      
      const canvas = document.createElement('canvas');
      canvas.className = 'sigpad';
      canvas.id = `sigExtra${i}`;
      
      const clearBtn = document.createElement('button');
      clearBtn.className = 'secondary';
      clearBtn.textContent = 'üóëÔ∏è Cancella firma';
      clearBtn.style.marginTop = '10px';
      
      container.appendChild(headerDiv);
      container.appendChild(canvas);
      container.appendChild(clearBtn);
      firmeAggWrap.appendChild(container);
      
      // Setup signature pad
      setTimeout(()=> setupSigExtra(canvas, clearBtn, i), 0);
    });
  }
  renderFirmeAggiuntive();
  
  window.handleAddFirma = () => {
    console.log('üîò handleAddFirma chiamata');
    state.firmeAggiuntive.push({label:'', firma:null});
    renderFirmeAggiuntive();
    save();
  };
  
  function setupSigExtra(cvs, btn, idx){
    const ctx = cvs.getContext('2d');
    let drawing = false, last = null;
    
    function resize(){
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      const w = cvs.clientWidth, h = cvs.clientHeight;
      cvs.width = w * ratio;
      cvs.height = h * ratio;
      ctx.scale(ratio, ratio);
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#111';
      
      if(state.firmeAggiuntive[idx] && state.firmeAggiuntive[idx].firma){
        const img = new Image();
        img.onload = ()=>{ ctx.drawImage(img, 0, 0, w, h); };
        img.src = state.firmeAggiuntive[idx].firma;
      }else{
        ctx.clearRect(0,0,w,h);
      }
    }
    resize();
    window.addEventListener('resize', resize);
    
    function start(x,y){ drawing = true; last = {x,y}; }
    function move(x,y){ if(!drawing) return; ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(x,y); ctx.stroke(); last = {x,y}; }
    function end(){ 
      drawing = false; 
      if(state.firmeAggiuntive[idx]){
        state.firmeAggiuntive[idx].firma = cvs.toDataURL('image/png'); 
        save(); 
      }
    }
    
    cvs.addEventListener('mousedown', e=> start(e.offsetX, e.offsetY));
    cvs.addEventListener('mousemove', e=> move(e.offsetX, e.offsetY));
    cvs.addEventListener('mouseup', end);
    cvs.addEventListener('mouseleave', end);
    cvs.addEventListener('touchstart', e=>{ const r=cvs.getBoundingClientRect(); const t=e.touches[0]; start(t.clientX-r.left, t.clientY-r.top); e.preventDefault(); }, {passive:false});
    cvs.addEventListener('touchmove', e=>{ const r=cvs.getBoundingClientRect(); const t=e.touches[0]; move(t.clientX-r.left, t.clientY-r.top); e.preventDefault(); }, {passive:false});
    cvs.addEventListener('touchend', end);
    
    btn.onclick = ()=>{ 
      ctx.clearRect(0,0,cvs.width,cvs.height); 
      if(state.firmeAggiuntive[idx]){
        state.firmeAggiuntive[idx].firma = null; 
        save(); 
        resize(); 
      }
    };
  }
  
  // Signature pads
  function setupSig(canvasId, clearBtnId, stateKey){
    const cvs = $(canvasId), btn = $(clearBtnId);
    const ctx = cvs.getContext('2d');
    let drawing = false, last = null;
    
    function resize(){
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      const w = cvs.clientWidth, h = cvs.clientHeight;
      cvs.width = w * ratio;
      cvs.height = h * ratio;
      ctx.scale(ratio, ratio);
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#111';
      
      if(state[stateKey]){
        const img = new Image();
        img.onload = ()=>{ ctx.drawImage(img, 0, 0, w, h); };
        img.src = state[stateKey];
      }else{
        ctx.clearRect(0,0,w,h);
      }
    }
    resize();
    window.addEventListener('resize', resize);
    
    function start(x,y){ drawing = true; last = {x,y}; }
    function move(x,y){ if(!drawing) return; ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(x,y); ctx.stroke(); last = {x,y}; }
    function end(){ drawing = false; state[stateKey] = cvs.toDataURL('image/png'); save(); }
    
    cvs.addEventListener('mousedown', e=> start(e.offsetX, e.offsetY));
    cvs.addEventListener('mousemove', e=> move(e.offsetX, e.offsetY));
    cvs.addEventListener('mouseup', end);
    cvs.addEventListener('mouseleave', end);
    cvs.addEventListener('touchstart', e=>{ const r=cvs.getBoundingClientRect(); const t=e.touches[0]; start(t.clientX-r.left, t.clientY-r.top); e.preventDefault(); }, {passive:false});
    cvs.addEventListener('touchmove', e=>{ const r=cvs.getBoundingClientRect(); const t=e.touches[0]; move(t.clientX-r.left, t.clientY-r.top); e.preventDefault(); }, {passive:false});
    cvs.addEventListener('touchend', end);
    
    btn.onclick = ()=>{ ctx.clearRect(0,0,cvs.width,cvs.height); state[stateKey]=null; save(); resize(); };
  }
  
  setupSig('sigDL','clearDL','firmaDL');
  setupSig('sigIMP','clearIMP','firmaIMP');
  
  // Ricarica tutte le visualizzazioni con i dati salvati
  // Usa setTimeout pi√π lungo per mobile e forza rendering aree/lavorazioni
  setTimeout(() => {
    console.log('‚è∞ Eseguendo refreshAll dopo 300ms');
    
    // Forza rendering aree ispezionate
    document.querySelectorAll('#areeChips input[type="checkbox"]').forEach(inp => {
      const area = inp.nextSibling.textContent.trim();
      if (state.aree[area]) {
        inp.checked = true;
      }
    });
    
    // Forza rendering lavorazioni
    document.querySelectorAll('#lavorazioniChips input[type="checkbox"]').forEach(inp => {
      const lav = inp.nextSibling.textContent.trim();
      if (state.lavorazioni[lav]) {
        inp.checked = true;
      }
    });
    
    refreshAll();
  }, 300);
  
  console.log('‚úÖ Tutte le funzioni window.handle esposte!');
}); // Fine DOMContentLoaded
</script>
</body>
</html>
